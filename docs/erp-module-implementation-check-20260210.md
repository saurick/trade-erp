# ERP 全模块实现核查（2026-02-10）

> 核查依据：
> - `/Users/simon/Downloads/外销erp/ExportSalesOpsSystem_Requirements_v2.md`
> - `/Users/simon/Downloads/外销erp/ExportSalesOpsSystem_Detail_v2.xlsx`
> - 前端模块定义与路由：`web/src/erp/config/moduleDefinitions.js`、`web/src/erp/router.jsx`
> - 后端 ERP 接口：`server/internal/data/jsonrpc.go`、`server/internal/biz/erp.go`

## 总结

- 11 个业务模块均已落地页面与基础 CRUD。
- 模块间主链路联动（报价→外销→采购→入库→库存→出运→出库→结汇→水单确认）已实现。
- 状态箱机制（草稿/待批/已批/招领/确认/免批）已实现通用流转。
- 服务端已补齐模块白名单、必填字段、数值范围、状态箱合法值和关键派生字段（`totalAmount`、`totalPackages`、`receivableDate`）校验。
- 当前仍有“部分实现”项，主要集中在审批角色约束与导入导出能力。

## 模块核查结果

| 序号 | 模块 | 实现状态 | 说明 |
|---|---|---|---|
| 1 | 客户/供应商 | 已实现（基础） | 有建档字段与合作客户自动编码、付款周期字段；支持 CRUD。 |
| 2 | 产品 | 已实现（基础） | 有产品编码、海关编码、规格图号、中英文描述、附件上传字段；支持 CRUD。 |
| 3 | 报价单（可选） | 已实现（基础） | 支持产品明细、打印 PI、生成外销。 |
| 4 | 外销 | 已实现（基础） | 支持关键字段、打印 PI、生成采购合同/出运明细。 |
| 5 | 采购（采购合同） | 已实现（基础） | 支持供应商选择、合同号生成、产品明细、打印采购合同、生成入库通知。 |
| 6 | 入库通知/检验/入库 | 已实现（基础） | 支持质检状态；“允许入库”会生成入库单号并增加库存。 |
| 7 | 库存 | 已实现（基础） | 单仓+货位模型；入库/出库联动增减库存。 |
| 8 | 出运明细 | 已实现（基础） | 支持关键字段、生成出库与结汇。 |
| 9 | 出库 | 已实现（基础） | 可由出运明细生成并自动扣减库存；模块支持 CRUD。 |
| 10 | 结汇 | 已实现（基础） | 支持从出运生成，按付款周期计算预计收汇日期。 |
| 11 | 水单→招领→认领确认 | 已实现（基础） | 支持水单登记与“认领确认”转确认箱。 |

## 尚未完全覆盖的需求点

1. 审批“角色/岗位约束”未做强校验，当前主要是通用状态流转与按钮操作。
2. Excel 导入/导出未实现。

## 当日新增补齐（2026-02-10）

1. 新增附件上传与访问接口：`/files/upload`、`/files/...`。
2. 新增模板上传与读取接口：`/templates/upload/{template_key}`、`/templates/file/{template_key}`。
3. 打印中心改为原始 Excel 模板加载，模板单元格支持全编辑后打印。
4. 新增 `/metrics` Prometheus 指标端点。
5. 服务端 ERP 新增模块级业务规则校验与关键派生字段计算。
6. 打印中心补充“开票信息模板”（来源 `杭州科森磁材开票信息.pdf`）并修复模板解析报错 `Invalid HTML: could not find <table>`。
7. 开票信息模板调整为坐标固定版式 1:1 打印，左右字段双向同步且右侧文字可编辑（logo/水印除外），避免表格化样式偏差。
8. 外销形式发票（PI）改为固定版式 1:1 打印并对齐原模板视觉，绕过 `sheet_to_html` 样式损失；PI 模板与开票信息一致支持左右字段双向同步，且不支持上传覆盖。
9. 采购合同模板改为固定版式 1:1 打印（按 `采购合同模版.pdf` 原始坐标重建，含原模板内嵌 logo/公章/底部示意图），绕过 `sheet_to_html` 样式损失；采购合同模板与 PI/开票信息一致支持左右字段双向同步，且不支持上传覆盖。
10. 打印模板编辑区增加“纯文本粘贴 + 失焦清洗”机制，避免富文本样式注入导致 PI/采购合同模板出现叠字、错位、覆盖。
11. PI 预览区增加“自动缩放适配容器”机制（仅预览生效），默认整页可见并避免滚动；打印仍按原始版式尺寸输出。
12. PI 模板切换为“完整页面坐标系”渲染：按 PDF 页面尺寸（1414x2000）与内容框偏移（70,64）布局，统一页面留白比例与边距，减少与原 PDF 截图差异。
13. PI 模板进一步细调：压缩标题与头部间距、回收买方信息区垂直留白、统一表格线条粗细与签章/银行区边框粗细，贴近 PDF 原稿的视觉节奏。
14. 打印模板范围收敛：仅保留“形式发票 PI”“采购合同”“开票信息”，其余模板入口已下线。
15. ERP 数据加载策略改为按路由懒加载：模块页仅请求当前模块及其 `select-ref` 引用模块，避免刷新时全模块并发请求。
